<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深入理解vite核心原理 | 曾广参</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="曾广参">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.7d1b523e.css" as="style"><link rel="preload" href="/assets/js/app.c918b425.js" as="script"><link rel="preload" href="/assets/js/3.ab96c64f.js" as="script"><link rel="preload" href="/assets/js/2.1cb06fef.js" as="script"><link rel="preload" href="/assets/js/51.579d3c09.js" as="script"><link rel="prefetch" href="/assets/js/1.9d99011a.js"><link rel="prefetch" href="/assets/js/10.0d0dcf08.js"><link rel="prefetch" href="/assets/js/100.247863f8.js"><link rel="prefetch" href="/assets/js/101.a1730869.js"><link rel="prefetch" href="/assets/js/102.25eff4cf.js"><link rel="prefetch" href="/assets/js/103.9afe084f.js"><link rel="prefetch" href="/assets/js/104.20c2c1d1.js"><link rel="prefetch" href="/assets/js/105.a02de3ad.js"><link rel="prefetch" href="/assets/js/106.af05988c.js"><link rel="prefetch" href="/assets/js/107.d6517dad.js"><link rel="prefetch" href="/assets/js/108.f6ee3b81.js"><link rel="prefetch" href="/assets/js/109.9e05daaf.js"><link rel="prefetch" href="/assets/js/11.80cd2373.js"><link rel="prefetch" href="/assets/js/110.390c9bb2.js"><link rel="prefetch" href="/assets/js/111.f4ea45c8.js"><link rel="prefetch" href="/assets/js/112.dfbd7769.js"><link rel="prefetch" href="/assets/js/113.8da1459c.js"><link rel="prefetch" href="/assets/js/114.c3474487.js"><link rel="prefetch" href="/assets/js/115.50ca204e.js"><link rel="prefetch" href="/assets/js/116.2a435581.js"><link rel="prefetch" href="/assets/js/117.84fe7e43.js"><link rel="prefetch" href="/assets/js/118.02aed350.js"><link rel="prefetch" href="/assets/js/12.1ed71737.js"><link rel="prefetch" href="/assets/js/13.f3225b38.js"><link rel="prefetch" href="/assets/js/14.df6260cd.js"><link rel="prefetch" href="/assets/js/15.e792d47f.js"><link rel="prefetch" href="/assets/js/16.9aea40ec.js"><link rel="prefetch" href="/assets/js/17.03754a76.js"><link rel="prefetch" href="/assets/js/18.54ac961c.js"><link rel="prefetch" href="/assets/js/19.b0fd36a2.js"><link rel="prefetch" href="/assets/js/20.06fb6319.js"><link rel="prefetch" href="/assets/js/21.a4083568.js"><link rel="prefetch" href="/assets/js/22.c8cf52f8.js"><link rel="prefetch" href="/assets/js/23.e69abffe.js"><link rel="prefetch" href="/assets/js/24.7a477a43.js"><link rel="prefetch" href="/assets/js/25.5998f841.js"><link rel="prefetch" href="/assets/js/26.5af03cf2.js"><link rel="prefetch" href="/assets/js/27.3069ad98.js"><link rel="prefetch" href="/assets/js/28.211d599b.js"><link rel="prefetch" href="/assets/js/29.7327102c.js"><link rel="prefetch" href="/assets/js/30.6eea8c6b.js"><link rel="prefetch" href="/assets/js/31.4dade068.js"><link rel="prefetch" href="/assets/js/32.4471b6aa.js"><link rel="prefetch" href="/assets/js/33.36f5e5e3.js"><link rel="prefetch" href="/assets/js/34.3e892c99.js"><link rel="prefetch" href="/assets/js/35.5cb6ce5f.js"><link rel="prefetch" href="/assets/js/36.341fe041.js"><link rel="prefetch" href="/assets/js/37.f25579f2.js"><link rel="prefetch" href="/assets/js/38.9d6de69a.js"><link rel="prefetch" href="/assets/js/39.c060d8b4.js"><link rel="prefetch" href="/assets/js/4.5691e7f4.js"><link rel="prefetch" href="/assets/js/40.503bc531.js"><link rel="prefetch" href="/assets/js/41.eff3bfdb.js"><link rel="prefetch" href="/assets/js/42.58c75452.js"><link rel="prefetch" href="/assets/js/43.bab12408.js"><link rel="prefetch" href="/assets/js/44.eb4273c1.js"><link rel="prefetch" href="/assets/js/45.099105b9.js"><link rel="prefetch" href="/assets/js/46.d87a0629.js"><link rel="prefetch" href="/assets/js/47.980d8e49.js"><link rel="prefetch" href="/assets/js/48.276a7f8f.js"><link rel="prefetch" href="/assets/js/49.eeb78591.js"><link rel="prefetch" href="/assets/js/5.2e71f0e7.js"><link rel="prefetch" href="/assets/js/50.bb19f0ca.js"><link rel="prefetch" href="/assets/js/52.3e83012c.js"><link rel="prefetch" href="/assets/js/53.4f6a146a.js"><link rel="prefetch" href="/assets/js/54.288653a1.js"><link rel="prefetch" href="/assets/js/55.edd49b91.js"><link rel="prefetch" href="/assets/js/56.388455c1.js"><link rel="prefetch" href="/assets/js/57.dd6f98d3.js"><link rel="prefetch" href="/assets/js/58.7cb63a42.js"><link rel="prefetch" href="/assets/js/59.aef5fd9f.js"><link rel="prefetch" href="/assets/js/6.e875ab4f.js"><link rel="prefetch" href="/assets/js/60.5a0eef55.js"><link rel="prefetch" href="/assets/js/61.92cea6aa.js"><link rel="prefetch" href="/assets/js/62.1a693b2c.js"><link rel="prefetch" href="/assets/js/63.55b0ba8a.js"><link rel="prefetch" href="/assets/js/64.a16b107e.js"><link rel="prefetch" href="/assets/js/65.e2ff57b3.js"><link rel="prefetch" href="/assets/js/66.27817686.js"><link rel="prefetch" href="/assets/js/67.b00bcc81.js"><link rel="prefetch" href="/assets/js/68.262dab69.js"><link rel="prefetch" href="/assets/js/69.441f56b1.js"><link rel="prefetch" href="/assets/js/70.ec14844f.js"><link rel="prefetch" href="/assets/js/71.8d8e6aaa.js"><link rel="prefetch" href="/assets/js/72.6af2998e.js"><link rel="prefetch" href="/assets/js/73.fc709d6f.js"><link rel="prefetch" href="/assets/js/74.f702fe7e.js"><link rel="prefetch" href="/assets/js/75.ed7dc326.js"><link rel="prefetch" href="/assets/js/76.b2e30956.js"><link rel="prefetch" href="/assets/js/77.626b63ff.js"><link rel="prefetch" href="/assets/js/78.10c3362b.js"><link rel="prefetch" href="/assets/js/79.63f79dfe.js"><link rel="prefetch" href="/assets/js/80.cf82dfce.js"><link rel="prefetch" href="/assets/js/81.19f74821.js"><link rel="prefetch" href="/assets/js/82.d1a379e9.js"><link rel="prefetch" href="/assets/js/83.48c94cf3.js"><link rel="prefetch" href="/assets/js/84.0fb98481.js"><link rel="prefetch" href="/assets/js/85.f8161443.js"><link rel="prefetch" href="/assets/js/86.4da15f6b.js"><link rel="prefetch" href="/assets/js/87.d1aa7e40.js"><link rel="prefetch" href="/assets/js/88.b1b65b97.js"><link rel="prefetch" href="/assets/js/89.75ab464d.js"><link rel="prefetch" href="/assets/js/9.906df462.js"><link rel="prefetch" href="/assets/js/90.cde09333.js"><link rel="prefetch" href="/assets/js/91.8e3f96c7.js"><link rel="prefetch" href="/assets/js/92.9931de76.js"><link rel="prefetch" href="/assets/js/93.1e53f01d.js"><link rel="prefetch" href="/assets/js/94.cb13aa03.js"><link rel="prefetch" href="/assets/js/95.3b088558.js"><link rel="prefetch" href="/assets/js/96.9ed8fd78.js"><link rel="prefetch" href="/assets/js/97.ff586f45.js"><link rel="prefetch" href="/assets/js/98.0584ed32.js"><link rel="prefetch" href="/assets/js/99.49415908.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.3a6fcd1b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7d1b523e.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">曾广参</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/#JavaScript" class="nav-link">JavaSript</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><a href="/frame/" class="link-title">框架</a> <span class="title" style="display:none;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Vue</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frame/Vue2/" class="nav-link">Vue2</a></li><li class="dropdown-subitem"><a href="/frame/Vue3/" class="nav-link">Vue3</a></li></ul></li><li class="dropdown-item"><h4>React</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frame/React/" class="nav-link">React_18</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/technology/#WebPack" class="nav-link">WebPack</a></li><li class="dropdown-item"><!----> <a href="/technology/#浏览器相关" class="nav-link">浏览器相关</a></li><li class="dropdown-item"><!----> <a href="/technology/#工程化相关" class="nav-link">工程化相关</a></li><li class="dropdown-item"><!----> <a href="/technology/#工作中遇到的问题以及解决方案" class="nav-link">工作中遇到的问题以及解决方案</a></li><li class="dropdown-item"><!----> <a href="/technology/#Git" class="nav-link">Git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="收藏" class="dropdown-title"><a href="/collect/" class="link-title">收藏</a> <span class="title" style="display:none;">收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/collect/#个人产出" class="nav-link">个人产出</a></li><li class="dropdown-item"><!----> <a href="/collect/#实用工具" class="nav-link">实用工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/1805674660/1805674660.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://pic.imgdb.cn/item/63fca046f144a01007247d23.jpg"> <div class="blogger-info"><h3>曾广参</h3> <span>起风了，唯有努力生存。</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/#JavaScript" class="nav-link">JavaSript</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><a href="/frame/" class="link-title">框架</a> <span class="title" style="display:none;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Vue</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frame/Vue2/" class="nav-link">Vue2</a></li><li class="dropdown-subitem"><a href="/frame/Vue3/" class="nav-link">Vue3</a></li></ul></li><li class="dropdown-item"><h4>React</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frame/React/" class="nav-link">React_18</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/technology/#WebPack" class="nav-link">WebPack</a></li><li class="dropdown-item"><!----> <a href="/technology/#浏览器相关" class="nav-link">浏览器相关</a></li><li class="dropdown-item"><!----> <a href="/technology/#工程化相关" class="nav-link">工程化相关</a></li><li class="dropdown-item"><!----> <a href="/technology/#工作中遇到的问题以及解决方案" class="nav-link">工作中遇到的问题以及解决方案</a></li><li class="dropdown-item"><!----> <a href="/technology/#Git" class="nav-link">Git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="收藏" class="dropdown-title"><a href="/collect/" class="link-title">收藏</a> <span class="title" style="display:none;">收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/collect/#个人产出" class="nav-link">个人产出</a></li><li class="dropdown-item"><!----> <a href="/collect/#实用工具" class="nav-link">实用工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/1805674660/1805674660.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>WebPack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工程化相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工作中遇到的问题以及解决方案</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vite</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d15a79/" aria-current="page" class="active sidebar-link">深入理解vite核心原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/d15a79/#vite和webpack的区别" class="sidebar-link">Vite和Webpack的区别</a></li><li class="sidebar-sub-header level2"><a href="/pages/d15a79/#前置知识" class="sidebar-link">前置知识</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/d15a79/#esm" class="sidebar-link">ESM</a></li><li class="sidebar-sub-header level3"><a href="/pages/d15a79/#esbuild" class="sidebar-link">Esbuild</a></li><li class="sidebar-sub-header level3"><a href="/pages/d15a79/#rollup" class="sidebar-link">Rollup</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/d15a79/#核心原理" class="sidebar-link">核心原理</a></li><li class="sidebar-sub-header level2"><a href="/pages/d15a79/#依赖预构建" class="sidebar-link">依赖预构建</a></li><li class="sidebar-sub-header level2"><a href="/pages/d15a79/#实现一个简易的vite" class="sidebar-link">实现一个简易的vite</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/d15a79/#首先启动一个node服务器" class="sidebar-link">首先启动一个node服务器</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/d15a79/#热更新" class="sidebar-link">热更新</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/d15a79/#前置" class="sidebar-link">前置</a></li><li class="sidebar-sub-header level3"><a href="/pages/d15a79/#更新" class="sidebar-link">更新</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/d15a79/#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>一些小工具</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/technology/#技术" data-v-06225672>技术</a></li><li data-v-06225672><a href="/technology/#Vite" data-v-06225672>Vite</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/1805674660/" target="_blank" title="作者" class="beLink" data-v-06225672>1805674660</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-05-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">深入理解vite核心原理<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="vite和webpack的区别"><a href="#vite和webpack的区别" class="header-anchor">#</a> Vite和Webpack的区别</h2> <p>vite作为当下最火的前端构建工具，快是他最趁手的武器。那么同样作为构建工具界的常青树的webpack和vite究竟有啥区别呢？</p> <ul><li>webpack在启动时会先构建出整个项目模块的依赖图，然后根据依赖图把所有的代码都构建一遍。最终生成一个bundle，并且每次代码有改动，他都会重新构建所有的东西。这样依赖项目一旦大了就会非常影响速度</li> <li>而vite则是在启动服务器后，通过中间件拦截请求，然后对请求的文件做一系列的编译之后返回。也就是说vite并不会再启动时去构建所有资源，而是在你用到哪个，他就构建哪个。真正意义上做到了按需加载。并且不会受项目大小影响</li></ul> <h2 id="前置知识"><a href="#前置知识" class="header-anchor">#</a> 前置知识</h2> <p>在学习vite之前，有必要先掌握一些前置知识</p> <h3 id="esm"><a href="#esm" class="header-anchor">#</a> ESM</h3> <p>其实就是js自身的模块化方案，而现在大部分浏览器已经支持esm了，也就是可以在script标签的type属性给上module，就可以使用import导入导出模块了。</p> <h3 id="esbuild"><a href="#esbuild" class="header-anchor">#</a> Esbuild</h3> <p>Vite在开发环境时底层使用Esbuild实现对.<code>ts、jsx、.</code>js代码文件的转化，所以先看下什么是es-build。</p> <p><code>Esbuild</code>是一个<code>JavaScript</code>  Bundler 打包和压缩工具（由Go编写，一般的构建工具都是有JS编写， 所以在cpu密集场景下，go的性能会比js要更好），它提供了与Webpack、Rollup等工具相似的资源打包能力。可以将JavaScript 和TypeScript代码打包分发在网页上运行。但其打包速度却是其他工具的10～100倍。</p> <p>目前他支持以下的功能：</p> <ul><li>加载器</li> <li>压缩</li> <li>打包</li> <li><code>Tree shaking</code></li> <li><code>Source map</code>生成
esbuild总共提供了四个函数：transform、build、buildSync、Service。有兴趣的可以移步官方文档了解。</li></ul> <h3 id="rollup"><a href="#rollup" class="header-anchor">#</a> Rollup</h3> <p>在生产环境下，vite使用Rollup来进行资源的打包</p> <p><code>Rollup</code>是基于<code>ESM</code>的<code>JavaScript</code>打包工具。相比于其他打包工具如<code>Webpack</code>，他总是能打出<code>更小</code>、<code>更快</code>的包。因为 <code>Rollup</code> 基于<code>ESM 模块</code>，比 <code>Webpack</code> 和 <code>Browserify</code>使用的<code>CommonJS模块机制</code>更高效。<code>Rollup</code>的亮点在于同一个地方，<code>一次性</code>加载。能针对源码进行<code>Tree Shaking</code>(去除那些已被定义但没被使用的代码)，以及 <code>Scope Hoisting</code> 以减小输出文件大小提升运行性能。</p> <p>Rollup分为build（构建）阶段和output generate（输出生成）阶段。主要过程如下：</p> <ul><li>获取入口文件的内容，包装成module，生成抽象语法树</li> <li>对入口文件抽象语法树进行依赖解析</li> <li>生成最终代码</li> <li>写入目标文件</li></ul> <h2 id="核心原理"><a href="#核心原理" class="header-anchor">#</a> 核心原理</h2> <p>当一个script标签类型为module时</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;/src/main.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>浏览器会发起一个http请求，去请求这个src的链路</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
<span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>当请求到了main文件之后又会去解析这个文件里的import，这些import又会引发http请求，去加载对应的资源</p> <p>vite的核心原理其实就是利用了浏览器现在已经支持esm，遇到import会去发起http请求。然后他在node 服务层起了一个拦截器来拦截这些请求，返回对应的处理好的资源。所以他全程都不会提前打包资源，而是真正的按需加载。这也就是为什么他比webpack快这么多的原因</p> <h2 id="依赖预构建"><a href="#依赖预构建" class="header-anchor">#</a> 依赖预构建</h2> <p>依赖预构建是vite在构建过程中至关重要的一环，上文说了，vite其实是利用了浏览器遇到import语法会发起http请求下载对应的资源来做到飞速的打包，那我们试想一下这样做难道真的就全是好处没有一点坏处吗？
当然不是，下面就一起来看看vite利用依赖的预构建都解决了哪些问题吧</p> <ul><li>兼容不同模块化的代码
<ul><li>我们在日常开发中会下载非常非常多的依赖包，而这些依赖包通常都会采用五花八门的模块化方案，webpack为什么要采用AST来解析js代码呢？其中有一个原因就是为了抹平模块化的差异，他会将js代码通过AST树来转换成一个浏览器能识别的代码。
而vite为了达到这种效果，所以会采用依赖预构建的方式来去抹平差异</li></ul></li> <li>路径重写
<ul><li>浏览器只能识别绝对路径和相对路径的引入，并不支持包名的引入，而我们在日常开发中引入依赖基本上都是通过包名的方式去引入。那vite为了解决这个问题，在依赖预构建的时候同时也会生成一个json的依赖路径映射文件。用来重写包名引入</li></ul></li> <li>尽可能的集成依赖文件，减少网络请求
<ul><li>在我们安装的依赖包里，可能也会依赖着别的包，这种深层次的嵌套如果不去处理就会造成在浏览器上发起非常非常多的请求。这是特别消耗性能的，同时这也就是为什么浏览器不支持包名的方式引入，因为他不知道你这个包到底依赖了多少东西，所以他
干脆就不兼容，不去做这种吃力不讨好的事情。而vite在预构建阶段会尽可能的将一个包以及他的依赖的内容都构建成一个文件，这样可以有效的减少网络请求</li></ul></li></ul> <h2 id="实现一个简易的vite"><a href="#实现一个简易的vite" class="header-anchor">#</a> 实现一个简易的vite</h2> <p>下面让我们跟随一个小栗子来深入的看一看vite到底是怎么做的</p> <h3 id="首先启动一个node服务器"><a href="#首先启动一个node服务器" class="header-anchor">#</a> 首先启动一个node服务器</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> connect <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//connect中间件，主要做拦截器的作用</span>

<span class="token keyword">const</span> <span class="token function-variable function">createServer</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 依赖预构建</span>
    <span class="token keyword">await</span> <span class="token function">optimizeDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>middlewares<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'simple-vite-dev-server start at localhost: 3000!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 拦截返回index html</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>indexHtmlMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 处理 js 和 vue 请求的中间件</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>transformMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>这样一个简单的node服务器就启动了。接下来我们要做的就是预构建我们的依赖。那为什么要预构建依赖呢？对此vite官方是这样解释的</p> <ul><li>兼容 CommonJS 和 AMD 模块的依赖</li> <li>减少模块间依赖引用导致过多的请求次数</li></ul> <p>预构建依赖，那当然是需要拿到所有的依赖，然后通过esbuild来构建啦。细心的同学可能会发现，每当我们启动好项目之后，node_modules目录下都会出现一个.vite目录以及一个_metadata.json的文件。.vite目录下其实就是存放所有被预构建之后的依赖文件的地方，而那个json文件就是资源路劲的映射文件件。下面看一张图感受一下</p> <img src="/assets/img/vite_1.4b6ae514.png" class="img"> <p>下面来着手写一下代码</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> esbuild <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'esbuild'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 因为我们的 vite 目录和测试的 src 目录在同一层，因此加了个../</span>
<span class="token keyword">const</span> cacheDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> <span class="token string">'node_modules/.vite'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">optimizeDeps</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>cacheDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>cacheDir<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">recursive</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 在分析依赖的时候 这里为简单实现就没按照源码使用 esbuild 插件去分析</span>
        <span class="token comment">// 而是直接简单粗暴的读取了上级 package.json 的 dependencies 字段</span>
        <span class="token keyword">const</span> deps <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 关于 esbuild 的参数可参考官方文档</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> esbuild<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">entryPoints</span><span class="token operator">:</span> deps<span class="token punctuation">,</span>
            <span class="token literal-property property">bundle</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'esm'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">logLevel</span><span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">splitting</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">sourcemap</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">outdir</span><span class="token operator">:</span> cacheDir<span class="token punctuation">,</span>
            <span class="token literal-property property">treeShaking</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">metafile</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">define</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">'process.env.NODE_ENV'</span><span class="token operator">:</span> <span class="token string">&quot;\&quot;development\&quot;&quot;</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> outputs <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>metafile<span class="token punctuation">.</span>outputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            data<span class="token punctuation">[</span>dep<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'/'</span> <span class="token operator">+</span> outputs<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">output</span> <span class="token operator">=&gt;</span> output<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dep<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> dataPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cacheDir<span class="token punctuation">,</span> <span class="token string">'_metadata.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>dataPath<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>完成到这里，其实就只剩下拦截请求了。只要把拦截到的请求做一个相对应的处理。我们的minivite就完成了</p> <p>首先我们拦截一下/，返回我们的index.html</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//当访问:3000/的时候读取根目录的html并且返回</span>
<span class="token keyword">const</span> <span class="token function-variable function">indexHtmlMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> htmlPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../index.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> htmlContent <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>htmlPath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>htmlContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>其次是js文件和vue文件。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//处理js和.vue文件</span>
<span class="token keyword">const</span> <span class="token function-variable function">transformMiddleware</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 因为预构建我们配置生成了 map 文件所以同样要处理下 map 文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.js'</span><span class="token punctuation">)</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.map'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> jsPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> code <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>jsPath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
        <span class="token comment">// map 文件不需要分析 import 语句</span>
        <span class="token keyword">const</span> transformCode <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.map'</span><span class="token punctuation">)</span> <span class="token operator">?</span> code <span class="token operator">:</span> <span class="token keyword">await</span> <span class="token function">importAnalysis</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>transformCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//处理.vue文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.vue'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> vuePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 拿到 vue 文件中的内容</span>
        <span class="token keyword">const</span> vueContent <span class="token operator">=</span>  fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>vuePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 通过@vue/compiler-sfc 将 vue 中的内容解析成 AST</span>
        <span class="token keyword">const</span> vueParseContet <span class="token operator">=</span> compileSFC<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>vueContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 得到 vue 文件中 script 内的 code</span>
        <span class="token keyword">const</span> scriptContent <span class="token operator">=</span> vueParseContet<span class="token punctuation">.</span>descriptor<span class="token punctuation">.</span>script<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
        <span class="token keyword">const</span> replaceScript <span class="token operator">=</span> scriptContent<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'export default '</span><span class="token punctuation">,</span> <span class="token string">'const __script = '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 得到 vue 文件中 template 内的内容</span>
        <span class="token keyword">const</span> tpl <span class="token operator">=</span> vueParseContet<span class="token punctuation">.</span>descriptor<span class="token punctuation">.</span>template<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
        <span class="token comment">// 通过@vue/compiler-dom 将其解析成 render 函数</span>
        <span class="token keyword">const</span> tplCode <span class="token operator">=</span> compileDom<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>tpl<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">;</span>
        <span class="token keyword">const</span> tplCodeReplace <span class="token operator">=</span> tplCode<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'export function render(_ctx, _cache)'</span><span class="token punctuation">,</span> <span class="token string">'__script.render=(_ctx, _cache)=&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 最后不要忘了 script 内的 code 还要再一次进行 import 语句分析替换</span>
        <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
                </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">await</span> <span class="token function">importAnalysis</span><span class="token punctuation">(</span>replaceScript<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
                </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tplCodeReplace<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
                export default __script;
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">importAnalysis</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//分析import语句，将依赖包引入路劲替换成构建包路劲</span>
<span class="token keyword">const</span> <span class="token function-variable function">importAnalysis</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// es-module-lexer 的 init 必须在 parse 前 Resolve</span>
    <span class="token keyword">await</span> init<span class="token punctuation">;</span>
    <span class="token comment">// 通过 es-module-lexer 分析源 code 中所有的 import 语句</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>imports<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果没有 import 语句我们直接返回源 code</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>imports <span class="token operator">||</span> <span class="token operator">!</span>imports<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> code<span class="token punctuation">;</span>
    <span class="token comment">// 定义依赖映射的对象</span>
    <span class="token keyword">const</span> metaData <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cacheDir<span class="token punctuation">,</span> <span class="token string">'_metadata.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// magic-string vite2 源码中使用到的一个工具 主要适用于将源代码中的某些轻微修改或者替换</span>
    <span class="token keyword">let</span> transformCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    imports<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">importer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// n： 表示模块的名称 如 vue</span>
        <span class="token comment">// s: 模块名称在导入语句中的起始位置</span>
        <span class="token comment">// e: 模块名称在导入语句中的结束位置</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> n<span class="token punctuation">,</span> s<span class="token punctuation">,</span> e <span class="token punctuation">}</span> <span class="token operator">=</span> importer<span class="token punctuation">;</span>
        <span class="token comment">// 得到模块对应预构建后的真实路径  如</span>
        <span class="token keyword">const</span> replacePath <span class="token operator">=</span> metaData<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">||</span> n<span class="token punctuation">;</span>
        <span class="token comment">// 将模块名称替换成真实路径如/node_modules/.vite</span>
        transformCode <span class="token operator">=</span> transformCode<span class="token punctuation">.</span><span class="token function">overwrite</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">,</span> replacePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> transformCode<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="热更新"><a href="#热更新" class="header-anchor">#</a> 热更新</h2> <p>HMR是开发过程中必不可少的一个功能，其实和webpack一样，vite的热更新也离不开websocket。vite往import.meta上挂载了一个hot对象，具体的热更新方法其实就是通过这个hot
对象身上的一些方法来实现的。
大致分为以下几步：</p> <h3 id="前置"><a href="#前置" class="header-anchor">#</a> 前置</h3> <ul><li>服务器启动时创建websocket示例，同时通过chokidir监听文件是否更改</li> <li>把热更新相关的代码注入html里面（这一点和webpack是一样的）</li> <li>执行客户端热更新代码：创建websocket示例去连接服务，创建一些存储数据的变量（存一些文件路径和回调函数，方便更新的时候查找和使用），并且注册一系列的监听事件</li> <li>当请求的文件中有import.meta.hot.accept时，向该文件注入回调函数（更新用）</li></ul> <h3 id="更新"><a href="#更新" class="header-anchor">#</a> 更新</h3> <ul><li>监听到文件更新</li> <li>如果时配置文件之类的，则直接重启服务器，否则通过websocket通知客户端</li> <li>根据模块路径向上查找，找到所有依赖此模块的模块。</li> <li>客户端接收到此消息后，通过import重新请求变更过后的模块，并且载url上挂上import和时间戳</li></ul> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>下面来总结一下vite的原理：</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>vite主要是借助了浏览器支持esm的特性，从而可以做到按需编译，按需加载。无需和webpack一样要打包所有内荣。这也是他速度快的第一大原因。
vite冷启动一个服务器，然后对浏览器的请求做拦截，从而去编译文件，最终返回给浏览器。而webpack则是统一处理好后再一起返回给浏览器，所以随着项目
的变大，速度也就会变慢。vite对于依赖这一块有着一个依赖预处理的方式，主要是为了抹平各种依赖包采用不同的模块化方案，以及缓存下这些模块，并且将嵌套过深的模块尽可能的集成处理。
这样做也会对速度有一个大大的提升。同时预编译还会存下依赖包和编译后的资源路径。方便重写我们代码中直接用包名引入依赖的方式（浏览器只支持绝对路径和相对路径import资源）。在热更新这一块vite的做法和webpack差不多，也是通过websocket实现的，
vite会往import.meta上挂在一个hot对象，这个对象上就包含了所有的热更新所需的方法。通过chokidir去监听文件的变更，然后把变更了的文件的内容以及所有依赖他的模块的路径都告知客户端，客户端去重新import这个更改过后的文件，同时在url上会拼上时间戳，防止缓存。</p></div></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/1805674660/1805674660.github.io/edit/master/docs/03.技术/06.Vite/01.深入理解vite核心原理.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/11/02, 21:25:43</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/e49859/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">git提交信息规范-commitlint</div></a> <a href="/pages/e61a38/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">二次封装axios</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/e49859/" class="prev">git提交信息规范-commitlint</a></span> <span class="next"><a href="/pages/e61a38/">二次封装axios</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/6a926c/"><div>
            工具
            <!----></div></a> <span class="date">11-02</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/f99927/"><div>
            一些小工具
            <!----></div></a> <span class="date">11-02</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/8dcf4d/"><div>
            妙用svg实现dom转image
            <!----></div></a> <span class="date">11-01</span></dt></dl> <dl><dd></dd> <dt><a href="/archives" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/1805674660/" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2023
    <span>曾广参 | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div><canvas id="vuepress-canvas-cursor"></canvas><!----><div></div></div></div>
    <script src="/assets/js/app.c918b425.js" defer></script><script src="/assets/js/3.ab96c64f.js" defer></script><script src="/assets/js/2.1cb06fef.js" defer></script><script src="/assets/js/51.579d3c09.js" defer></script>
  </body>
</html>
